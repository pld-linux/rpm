--- rpm-5.4.18/rpmio/macro.c~	2017-07-18 16:19:04.000000000 +0300
+++ rpm-5.4.18/rpmio/macro.c	2017-07-18 16:30:30.419934771 +0300
@@ -807,6 +807,43 @@
     return se;
 }
 
+void delMacroAll(MacroContext mc, const char * n);
+
+/**
+ * Parse (and execute) macro undefinition.
+ * @param mc		macro context
+ * @param se		macro name to undefine
+ * @return		address to continue parsing
+ */
+/*@dependent@*/ static const char *
+doUnglobal(MacroContext mc, /*@returned@*/ const char * se)
+	/*@globals rpmGlobalMacroContext @*/
+	/*@modifies mc, rpmGlobalMacroContext @*/
+{
+    const char *s = se;
+    char *buf = alloca(_macro_BUFSIZ);
+    char *n = buf, *ne = n;
+    int c;
+
+    COPYNAME(ne, s, c);
+
+    /* Move scan over body */
+    while (iseol(*s))
+	s++;
+    se = s;
+
+    /* Names must start with alphabetic or _ and be at least 3 chars */
+    if (!((c = *n) && (xisalpha(c) || c == '_') && (ne - n) > 2)) {
+	rpmlog(RPMLOG_ERR,
+		_("Macro %%%s has illegal name (%%unglobal)\n"), n);
+	return se;
+    }
+
+    delMacroAll(mc, n);
+
+    return se;
+}
+
 #ifdef	DYING
 static void
 dumpME(const char * msg, MacroEntry me)
@@ -1430,6 +1465,10 @@
 		s = doUndefine(mb->mc, se);
 		continue;
 	}
+	if (STREQ("unglobal", f, fn)) {
+		s = doUnglobal(mb->mc, se);
+		continue;
+	}
 
 	if (STREQ("echo", f, fn) ||
 	    STREQ("warn", f, fn) ||
@@ -3207,6 +3207,18 @@
     }
 }
 
+void
+delMacroAll(MacroContext mc, const char * n)
+{
+	MacroEntry * mep;
+
+	if (mc == NULL) mc = rpmGlobalMacroContext;
+	/* If name exists, pop entry */
+	while ((mep = findEntry(mc, n, 0)) != NULL) {
+		delMacro(mc, n);
+	}
+}
+
 int
 rpmDefineMacro(MacroContext mc, const char * macro, int level)
 {
